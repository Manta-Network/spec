\lsection{Concepts}{concepts}
\subsection{Assets}

\Asset{} is the fundamental currency object in the \MantaPay{} protocol. An asset $a : \Asset$ is a tuple
\[a = (a.\ID, a.\VALUE) : \AssetId \times \AssetValue\]
where the \AssetId{} encodes the type of currency stored in $a$ and the \AssetValue{} encodes how many units of that currency are stored in $a$.  \MantaPay{} is a \emph{decentralized anonymous payment} protocol which facilitiates the private ownership and private transfer of \Asset{} objects. 


We use \PublicAsset{} and \SecretAsset{} to explicitly describe whether an \Asset{} is visible to public.
More specifically, whenever an \Asset{} is being used in a public setting, we refer to it as a \PublicAsset{}, 
but when the \AssetId{} and/or \AssetValue{} of a particular \Asset{} is meant to be hidden from public view, we refer to the \Asset{} as either \emph{secret}, \emph{private}, \emph{hidden}, or \emph{shielded} with \SecretAsset{} type.

\Asset{s} are the basic building-blocks of \emph{transactions} which consume a set of input \Asset{s} and produce a set of transformed output \Asset{s}. To preserve the economic value stored in \Asset{s}, the sum of the input \AssetValue{s} must balance the sum of the output \AssetValue{s}, and all assets in a single transaction must have the same \AssetId{}\footnotemark{}.\footnotetext{It is beyond the scope of this paper to discuss transactions with inputs and outputs that feature different \AssetId{s}, like those that would be featured in a \emph{decentralized anonymous exchange}.} This is called a \emph{balanced transfer}: no \AssetValue{} is created or destroyed in the process. The \MantaPay{} protocol uses a distributed algorithm called \Transfer{} to perform balanced transfers and ensure that they are valid.

\lsubsection{Addresses}{addresses}

In order for \MantaPay{} participants to receive \Asset{s} via the \Transfer{} protocol, they create a \emph{shielded addresses} which they use as identifiers to represent them on the ledger.

\begin{center}
    \vspace{1em}
    \begin{mdframed}[leftmargin=0.2\textwidth, rightmargin=0.2\textwidth]
        \begin{center}
            \begin{tikzcd}
                & \sk \arrow[ld] \arrow[rd] & & & \\
                \sk_\alpha \arrow[rd] & & \ak \arrow[ld] \arrow[r] & \vk \arrow[r] & (\textsf{D}, \pk_\textsf{D}) \\
                & \ak_\alpha & & &
            \end{tikzcd}
        \end{center}
    \end{mdframed}
    \vspace{-1em}
    \captionof{figure}{Key Schedule for \MantaPay{}.}
\end{center}

\MantaPay{} uses four kinds of keys all derived from a base secret, spending key $\sk$, which give the following kinds of privileged access in the protocol:

\begin{itemize}
    \item \textbf{Shielded Address} (\send{}): Access to the shielded address $(\textsf{D}, \pk_\textsf{D})$ gives the user the right to send \Asset{s} to the owner of the associated $\sk$. The diversifier $\textsf{D}$ allows the owner of a given $\sk$ key to generate many shielded addresses with the same backing spend authority.
    \item \textbf{Viewing Key} (\view{}): Access to the viewing key $\vk$ gives the user the right to view all transactions for the owner of the associated $\sk$.
    \item \textbf{Proof Authorization Key} (\prove{}): Proof authorization key $\ak$ gives the user the right to build the transaction proof on behalf of the owner of $\sk$. 
    In the cases of delegating proof generation, i.e. using hardware wallet to control the $sk$ or signing associated data in transparent UTXOs, 
    the owner of the secret key generates a randomizer $\alpha$ and sends it to the prover which generates the proof. The owner then signs the transaction against $\ak_\alpha$ with their randomized key $\sk_\alpha$ which proves that they have knowledge of $\sk$.
    \item \textbf{Spending Key} (\spend{}): Access to the spending key $\sk$ gives total control over the assets owned by this secret, including spending, proof generation, and viewing.
\end{itemize}

Participants in \MantaPay{} are represented by their addresses, but they are not unique representations, since one participant may have access to more than one secret key. See \autoref{sec:addresses-and-key-components} for more information on how these keys are constructed and used for spending, proving, viewing, and receiving.

\subsection{Ledger}

We model a blockchain as a byzantine fault tolerance replicated state
machine with append only state, a.k.a ledger. When interacting with the blockchain, we call the entity who
initiates the interaction (e.g., sending a transfer request) the user; the entity who verifies the interaction and
logs it into the blockchain the validator (also known as miner in other contents). Users interact with the
blockchain by sending amendment requests to the ledger. The amendment is appended to the database once
validators approve the request. For simplicity, we assume 1) the ledger is synchronized, and the block finality
is instant; 2) the validators are trusted for liveness and completeness. The underlying consensus protocol
that validators employ is indeed orthogonal to this paper. What is also of out the scope of this paper is
the governance token for the underlying blockchain. We nonetheless assume that the senders of our protocol
holds enough governance tokens to send the transactions.

More specifically, \MantaPay{}'s ledger state \Ledger{} consists of two parts: the public ledger as \PublicLedger{}, and the shielded asset pool as \ShieldedAssetPool{}.

\begin{center}
    \vspace{1em}
    \begin{mdframed}[leftmargin=0.2\textwidth, rightmargin=0.2\textwidth]
        \begin{center}
            \begin{tikzcd}
                && \TUTXOSet \arrow[ld, "\spend" description, bend right] \\
                \PublicLedger \arrow[r, "\mint"', bend right]
                & \textbf{\Transfer} \arrow[l, "\reclaim"', bend right]
                \arrow[rd, "\spend" description]
                \arrow[ru, "\allocate" description, bend right] & \\
                && \VoidNumberSet
            \end{tikzcd}
        \end{center}
    \end{mdframed}
    \vspace{-1em}
    \captionof{figure}{Life cycle of an \Asset{}.}
\end{center}

The \ShieldedAssetPool{} is made up of three parts that are used to enforce the balanced transfer of \SecretAsset{s} among anonymous participants:

\begin{enumerate}
    \item \autoref{sec:ledger-utxo-set} \TUTXOSet{}: The \TUTXOSet{} is a collection of ownership claims to subsets of the \ShieldedAssetPool{} (called \TUTXO{s}), each one refering to an allocated \SecretAsset{} transfered to a participant of the protocol.
    \item \autoref{sec:ledger-encrypted-notes} \EncryptedNote{s}: For every \UTXO{} there is a matching \EncryptedNote{} which contains information necessary to spend the \SecretAsset{}, which can be used to \emph{provably reconstruct} the \UTXO{} convincing the \Ledger{} of unique ownership. The \EncryptedNote{} can only be decrypted by the recipient of the \SecretAsset{} or the designated viewer of the \UTXO{}, specifically, the correct viewing key $\vk$. See \autoref{sec:addresses} for more.
    \item \autoref{sec:ledger-void-number-set} \VoidNumberSet{}: The \VoidNumberSet{} is a collection of commitments, like \UTXO{s}, but which track the \emph{spent state} of a \SecretAsset{} and are used to prove to the \Ledger{} that a \SecretAsset{} is spent \emph{exactly one time}. 
\end{enumerate}

The operation of these different parts of the \ShieldedAssetPool{} is elaborated in the following subsections.

\lsubsubsection{\UTXO{s}, \TUTXO{s} and the \TUTXOSet{}}{ledger-utxo-set}

An \emph{unspent transaction output}, or \UTXO{} for short, represents a claim to the private output of a balanced transfer which has 
\emph{not yet been spent}. Every balanced transfer can produce some number of \emph{public outputs}, represented by \PublicAsset{s}, and/or 
\emph{private outputs}, represented by \UTXO{s}.

A \emph{transparent unspent transaction output}, or \TUTXO{} for short, is an extension of \PublicAsset{} and \UTXO{}. More specifically, a 
$\tutxo$ : \TUTXO{} is a tuple 
\begin{align*}
    \tutxo = (\pa, \utxo, \saiz, \ID) : \PublicAsset \times \UTXO \times \Bool \times \tUTXOID
\end{align*}
Here, \emph{secret asset is zero}, or \saiz{} for short, is a boolean indicating whether \utxo{} has underlying \AssetValue{}
as zero. 
\tUTXOID{} is an identification to distinguish two \TUTXO{s} with the same \PublicAsset{} and \UTXO{}.
Every balanced transfer generates some number of \TUTXO{s} and these \TUTXO{s} are stored in the \TUTXOSet{} 
of the \ShieldedAssetPool{}. A \TUTXO{} can only be claimed by the participant who owns the underlying \SecretAsset{}, where ownership means 
\emph{knowledge of the correct spending key} and the \Transfer{} protocol requires that all inputs to a balanced transfer \emph{prove} 
that they own a \TUTXO{} which the \ShieldedAssetPool{} has already seen in the past.
The \TUTXOSet{} is \emph{append-only} since it represents the past state of \emph{unspent} \SecretAsset{s}. \TUTXO{s} can only be added to the 
\TUTXOSet{} as outputs in the execution of a \Transfer{} which the \Ledger{} checks for correctness.

\lsubsubsection{\EncryptedNote{s}}{ledger-encrypted-notes}

In order to find out what \SecretAsset{} a \UTXO{} is connected to, every \UTXO{} comes with an associated \EncryptedNote{} which stores two pieces of information, the underlying (\AssetId{}, \AssetValue{}), and an ephemeral public key, a value which allows the new owner of the \SecretAsset{} to reconstruct the \UTXO{}. Being able to \emph{provably reconstruct} a correct \UTXO{} is a prerequisite to ownership and the ability to spend the \SecretAsset{} in the future. Once a participant spends a \SecretAsset{} that they can decrypt, they build a new \EncryptedNote{} for the next participant that they sent their \SecretAsset{s} to, so that they can then spend it, and so on. This is called the \emph{in-band secret distribution}.

\lsubsubsection{\VoidNumber{s} and the \VoidNumberSet{}}{ledger-void-number-set}

Once the ability to spend a \SecretAsset{} is extracted from a $(\UTXO, \EncryptedNote)$ pair, the \ShieldedAssetPool{} requires another commitment in order to spend the \SecretAsset{}, transfering it to another participant. This commitment, called the \VoidNumber{}, represents the revocation of the right to spend the \SecretAsset{} in the future, and ensures that the same \SecretAsset{} cannot be spent twice. Like the \TUTXOSet{}, the \VoidNumberSet{} is \emph{append-only} since it represents the past state of \emph{spent} \SecretAsset{s}. \VoidNumber{s} can only be added to the \VoidNumberSet{} as inputs in the execution of a \Transfer{} which the \Ledger{} checks for correctness.
